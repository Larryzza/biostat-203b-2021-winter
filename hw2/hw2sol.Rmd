---
title: "Biostat 203B Homework 1"
author: Zian ZHUANG
subtitle: Due Jan 22 @ 11:59PM
output:
  html_document:
    highlight: pygments
    toc: yes
    toc_float: yes
---

<!-- Setup -->
<style type="text/css">
body{ /* Normal  */
      font-size: 17px;
      font-family: "Times New Roman";
  }
h1,h2,h3,h4,h5,h6{
  font-family: "Times New Roman";
}
</style>
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache = TRUE, cache.lazy = FALSE)
library(tidyverse)
library(data.table)
library(lubridate)
library(magrittr)
```
<!-- Begin writing -->

Display machine information for reproducibility:
```{r}
sessionInfo()
```

```{r}
os <- sessionInfo()$running
if (str_detect(os, "Linux")) {
  mimic_path <- "/usr/203b-data/mimic-iv"
} else if (str_detect(os, "macOS")) {
  mimic_path <- "Please double check your path"
}
```
Use tidyverse (ggpot2, dplyr) to explore the [MIMIC-IV](https://mimic-iv.mit.edu) data introduced in [homework 1](https://ucla-biostat203b-2021winter.github.io/hw/hw1/hw1.html).

```{r}
system(str_c("tree -s -L 2 ", shQuote(mimic_path)), intern = TRUE)
```

## Q1. PhysioNet credential

### Q1.1
At this moment, you should already get credentialed on the PhysioNet. Please include a screenshot of your `Data Use Agreement for the MIMIC-IV (v0.4)`.

> **solution**: ![screenshot](/home/zianzhuang/biostat-203b-2021-winter/hw2/agreement.png)
 
## Q2. `read.csv` (base R) vs `read_csv` (tidyverse) vs `fread` (data.table)

There are quite a few utilities in R for reading data files. Let us test the speed of reading a moderate sized compressed csv file, `admissions.csv.gz`, by three programs: `read.csv` in base R, `read_csv` in tidyverse, and `fread` in the popular data.table package. Is there any speed difference?

In this homework, we stick to the tidyverse. 

> **solution**: 
```{r}
timer <- function(fun_input){
  timestart<-Sys.time()
  adm <- fun_input(paste0(mimic_path,"/core/admissions.csv.gz")) 
  timeend<-Sys.time()
  return(timeend-timestart)
}
lapply(list("read_csv" = read_csv,
            "read.csv" = read.csv,
            "fread" = fread),timer)
``` 
`fread` is proved to be the fastest function to read the file. `read.csv` is the slowest function.

## Q3. ICU stays

`icustays.csv.gz` (<https://mimic-iv.mit.edu/docs/datasets/icu/icustays/>) contains data about Intensive Care Units (ICU) stays. Summarize following variables using appropriate numerics or graphs: 

```{r}
icustays <- read_csv(paste0(mimic_path,"/icu/icustays.csv.gz"))
```

### Q3.1 how many unique `stay_id`? 

> **solution**: 
```{r}
icustays %>% 
  distinct(stay_id) %>% 
  nrow() %>%
  paste0(., " unique stay_id")  
```

### Q3.2 how many unique `subject_id`?  

> **solution**:
```{r}
icustays %>%  
  distinct(subject_id) %>% 
  nrow() %>%
  paste0(., " unique subject_id")
```

### Q3.3 length of ICU stay

> **solution**:
```{r}
icustays$los %>% summary
ggplot(data = icustays) +
  geom_histogram(mapping = aes(x = los), bins = 150) +
  scale_x_log10() +
  xlab("length of ICU stay (days)")+
  theme_classic() 
```

### Q3.4 first ICU unit 

> **solution**:
```{r}
icustays %>% 
  group_by(first_careunit) %>% 
  summarise(n = n()) %>%
  arrange(desc(n))
ggplot(data = icustays, 
       mapping = aes(x = factor(1), fill = first_careunit)) +
  scale_fill_discrete(name = "ICUs") +
  xlab(NULL) +
  ylab(NULL) +
  geom_bar() + 
  coord_polar("y") +
  theme(axis.ticks = element_blank(), 
        axis.text.y = element_blank())
```

### Q3.5 last ICU unit

> **solution**:
```{r}
icustays %>% 
  group_by(last_careunit) %>% 
  summarise(n = n()) %>%
  arrange(desc(n))
ggplot(data = icustays, 
       mapping = aes(x = factor(1), fill = last_careunit)) +
  scale_fill_discrete(name = "ICUs") +
  xlab(NULL) +
  ylab(NULL) +
  geom_bar() + 
  coord_polar("y") +
  theme(axis.ticks = element_blank(), 
        axis.text.y = element_blank())
```

## Q4. `admission` data

Information of the patients admitted into hospital is available in `admissions.csv.gz`. See <https://mimic-iv.mit.edu/docs/datasets/core/admissions/> for details of each field in this file. Summarize following variables using appropriate graphs. Explain any patterns you observe.   

```{r}
adm <- read_csv(paste0(mimic_path,"/core/admissions.csv.gz"))
```

Note it is possible that one patient (uniquely identified by the `subject_id`) is admitted into hospital multiple times. When summarizing some demographic information, it makes sense to summarize based on unique patients.

### Q4.1 admission year

> **solution**:
```{r}
adm %<>% mutate(admission_year=year(adm$admittime))
adm$admission_year %>% summary
ggplot(adm, aes(x = admission_year)) + 
  geom_bar(colour = "black", fill = "white") +
  theme_classic()
```

### Q4.2 admission month 

> **solution**:
```{r}
adm %<>% mutate(admission_month=month(adm$admittime))
adm %>% 
  group_by(admission_month) %>% 
  summarise(n = n(), .groups = "keep") %>%
  arrange(desc(n))
ggplot(adm) + 
  geom_bar(mapping = aes(x = admission_month, 
                         fill = admission_month %>% as.factor)) +
  scale_fill_discrete(name = "month") +
  theme(axis.text.x = element_blank(), 
        axis.ticks = element_blank(),
        panel.background = element_blank(),
        axis.line = element_line(colour = "black"))
```

### Q4.3 admission month day 

> **solution**:
```{r}
adm %<>% mutate(admission_monthday=day(adm$admittime))
adm$admission_monthday %>% summary
ggplot(adm, aes(x = admission_monthday)) + 
  geom_bar(colour = "black", fill = "white") +
  theme_classic()
```

### Q4.4 admission week day

> **solution**:
```{r}
adm %<>% mutate(admission_weekday=wday(adm$admittime))
adm %>% 
  group_by(admission_weekday) %>% 
  summarise(n = n(), .groups = "keep") %>%
  arrange(desc(n))
ggplot(adm) + 
  geom_bar(mapping = aes(x = admission_weekday, 
                         fill = admission_weekday %>% as.factor)) +
  scale_fill_discrete(name = "weekday") +
  theme(axis.text.x = element_blank(), 
        axis.ticks = element_blank(),
        panel.background = element_blank(),
        axis.line = element_line(colour = "black"))
```

### Q4.5 admission hour (anything unusual?) 

> **solution**:
```{r}
adm %<>% mutate(admission_hour=hour(adm$admittime))
adm$admission_hour %>% summary
ggplot(adm, aes(x = admission_hour)) + 
  geom_bar(colour = "black", fill = "white") +
  theme_classic() 
```

### Q4.6 number of deaths in each year 

> **solution**:
```{r}
adm %>%
  filter(is.na(deathtime)==F) %>%
  group_by(admission_year) %>%
  summarise(n = n(), .groups = "keep") %>%
  arrange(desc(n))
ggplot(adm %>% filter(is.na(deathtime)==F), 
       aes(x = admission_year)) + 
  geom_bar(colour = "black", fill = "white") +
  theme_classic()
```

### Q4.7 admission type  

> **solution**:
```{r}
adm %>% 
  group_by(admission_type) %>%
  summarise(n = n(), .groups = "keep") %>%
  arrange(desc(n))
ggplot(adm) + 
  geom_bar(mapping = aes(x = admission_type, fill = admission_type)) +
  theme(axis.text.x = element_blank(), 
        axis.ticks = element_blank(),
        panel.background = element_blank(),
        axis.line = element_line(colour = "black"))
```

### Q4.8 number of admissions per patient 

> **solution**:

```{r}
adm %>% 
  group_by(subject_id) %>%
  summarise(n = n(), .groups = "keep") %>%
  arrange(n) %>%
  mutate(num = ifelse(n>=5,5,n)) -> number_of_ad
number_of_ad$num %<>% ordered(levels = c("1", "2", "3", "4", "5"))
ggplot(number_of_ad) + 
  geom_bar(mapping = aes(x = num , fill = num)) +
  xlab("number of admissions") +
  scale_fill_discrete(name = "number of admissions", 
                      labels = c("1", "2", "3", "4", ">=5")) +
  xlab(NULL) +
  theme(panel.background = element_blank(),
        axis.line = element_line(colour = "black"))
```

### Q4.9 admission location

> **solution**:
```{r}
adm %>% 
  group_by(admission_location) %>%
  summarise(n = n(), .groups = "keep") %>%
  arrange(desc(n))
ggplot(adm) + 
  geom_bar(mapping = aes(x = admission_location, fill = admission_location)) +
  scale_y_sqrt() +
  theme(axis.text.x = element_blank(), 
        axis.ticks = element_blank(),
        panel.background = element_blank(),
        axis.line = element_line(colour = "black"))
```

### Q4.9 discharge location 

> **solution**:
```{r}
adm %>% 
  group_by(discharge_location) %>%
  summarise(n = n(), .groups = "keep") %>%
  arrange(desc(n))
ggplot(adm) + 
  geom_bar(mapping = aes(x = discharge_location, fill = discharge_location)) +
  scale_y_sqrt() +
  theme(axis.text.x = element_blank(), 
        axis.ticks = element_blank(),
        panel.background = element_blank(),
        axis.line = element_line(colour = "black"))
```

### Q4.10  insurance 

> **solution**: (summarized based on unique patients)
```{r}
adm %>% 
  distinct(subject_id, .keep_all = TRUE) %>% 
  group_by(insurance) %>%
  summarise(n = n(), .groups = "keep") %>%
  arrange(desc(n))
ggplot(adm %>% 
  distinct(subject_id, .keep_all = TRUE)) + 
  geom_bar(mapping = aes(x = insurance, fill = insurance)) +
  theme(axis.text.x = element_blank(), 
        axis.ticks = element_blank(),
        panel.background = element_blank(),
        axis.line = element_line(colour = "black"))
```

### Q4.11 language 

> **solution**: (summarized based on unique patients)
```{r}
adm %>% 
  distinct(subject_id, .keep_all = TRUE) %>% 
  group_by(language) %>%
  summarise(n = n(), .groups = "keep") %>%
  arrange(desc(n))
ggplot(adm %>% 
  distinct(subject_id, .keep_all = TRUE)) + 
  geom_bar(mapping = aes(x = language, fill = language)) +
  scale_fill_discrete(label = c("unknown","English")) +
  theme(axis.text.x = element_blank(), 
        axis.ticks = element_blank(),
        panel.background = element_blank(),
        axis.line = element_line(colour = "black"))
```

### Q4.12 marital status

> **solution**: (summarized based on unique patients)
```{r}
adm %>% 
  distinct(subject_id, .keep_all = TRUE) %>%
  group_by(marital_status) %>%
  summarise(n = n(), .groups = "keep") %>%
  arrange(desc(n))
ggplot(adm %>% 
  distinct(subject_id, .keep_all = TRUE)) + 
  geom_bar(mapping = aes(x = marital_status, fill = marital_status)) +
  scale_fill_discrete(name = "marital status") +
  theme(axis.text.x = element_blank(), 
        axis.ticks = element_blank(),
        panel.background = element_blank(),
        axis.line = element_line(colour = "black"))
```

### Q4.13 ethnicity  

> **solution**: (summarized based on unique patients)
```{r}
adm %>% 
  distinct(subject_id, .keep_all = TRUE) %>% 
  group_by(ethnicity) %>%
  summarise(n = n(), .groups = "keep") %>%
  arrange(desc(n))
ggplot(adm %>% 
  distinct(subject_id, .keep_all = TRUE)) + 
  geom_bar(mapping = aes(x = ethnicity, fill = ethnicity)) +
  scale_fill_discrete(name = "ethnicity") +
  scale_y_sqrt() +
  theme(axis.text.x = element_blank(), 
        axis.ticks = element_blank(),
        panel.background = element_blank(),
        axis.line = element_line(colour = "black"))
```

### Q4.14 death

> **solution**:
```{r}
adm %<>% mutate(death = ifelse(is.na(deathtime)==F, "Yes", "No"))
adm %>% 
  group_by(death) %>%
  summarise(n = n(), .groups = "keep") %>%
  arrange(desc(n))
ggplot(adm) + 
  geom_bar(mapping = aes(x = death, fill = death)) +
  scale_fill_discrete(name = "death") +
  scale_y_sqrt() +
  theme(axis.text.x = element_blank(), 
        axis.ticks = element_blank(),
        panel.background = element_blank(),
        axis.line = element_line(colour = "black"))
```

## Q5. `patient` data

Explore `patients.csv.gz` (<https://mimic-iv.mit.edu/docs/datasets/core/patients/>) and summarize following variables using appropriate numerics and graphs:  

```{r}
patients <- read_csv(paste0(mimic_path,"/core/patients.csv.gz"))
```

### Q5.1 `gender` 

> **solution**:
```{r}
patients %>% 
  distinct(subject_id, .keep_all = TRUE) %>%
  group_by(gender) %>%
  summarise(n = n(), .groups = "keep")
ggplot(patients %>% 
  distinct(subject_id, .keep_all = TRUE)) + 
  geom_bar(mapping = aes(x = gender, fill = gender)) +
  scale_fill_discrete(name = "gender", 
                      label = c("Female", "Male")) +
  theme(axis.text.x = element_blank(), 
        axis.ticks = element_blank(),
        panel.background = element_blank(),
        axis.line = element_line(colour = "black"))
```

### Q5.2 `anchor_age` 
(explain pattern you see)

> **solution**: According to the summary statistics, the mean anchor age of patients are 41. And figure presents that the anchor age of patients has two peak at 0 and 25 respectively. Very few patients have anchor age at around 10.
```{r}
patients %>% 
  distinct(subject_id, .keep_all = TRUE) %>%
  select(anchor_age) %>%
  summary
ggplot(patients %>% 
  distinct(subject_id, .keep_all = TRUE)) + 
  geom_density(mapping = aes(x = anchor_age)) +
  xlab("anchor_age")+
  theme_classic() 
```

## Q6. Lab results

`labevents.csv.gz` (<https://mimic-iv.mit.edu/docs/datasets/hosp/labevents/>) contains all laboratory measurements for patients. 

We are interested in the lab measurements of creatinine (50912), potassium (50971), sodium (50983), chloride (50902), bicarbonate (50882), hematocrit (51221), white blood cell count (51301), glucose (50931), magnesium (50960), calcium (50893), and lactate (50813). Find the `itemid`s of these lab measurements from `d_labitems.csv.gz` and retrieve a subset of `labevents.csv.gz` only containing these items.

**Quick check the data file**
```{r}
readLines(str_c(mimic_path,"/hosp/labevents.csv.gz"),n = 5L)
```

**begin data processing**
```{r, eval=F}
item_list <- c("creatinine", "potassium", "sodium", 
               "chloride", "bicarbonate", "hematocrit", 
               "white blood cell", "glucose", 
               "magnesium", "calcium", "lactate")
lab_name <- c("subject_id", "hadm_id", "itemid",
              "charttime", "valuenum")

labitems <- fread(paste0(mimic_path,"/hosp/d_labitems.csv.gz"))

#read and save
 
if (!file.exists("labevents_icu.csv.gz")){
  system.time(labevents <- fread(str_c(mimic_path,"/hosp/labevents.csv.gz"),
                     select = lab_name, nThread = getDTthreads()))
  labevents %>%
    semi_join(icustays, by = c("subject_id", "hadm_id")) %>%
    fwrite("labevents_icu.csv.gz", nThread = getDTthreads())
}
system.time(labevents_icu <- fread("labevents_icu.csv.gz",
                                   nThread = getDTthreads()))

#define lookup function

look_up <- function(x){
  labitems %>%
    filter(str_detect(label, regex(x, ignore_case = T))) %>%
    select(itemid,label)
}
find_id <- function(x){
  labevents_icu %>%
    filter(itemid %in% as_vector(x$itemid)) %>%
    count(itemid) %>%
    arrange(desc(n)) -> count
  return(count[1,1])
}

#find item id we need

idkey_all <- lapply(item_list %>% as.list, look_up)
idkey <- sapply(idkey_all, find_id)

labevents_icu %<>%
  filter(itemid %in% as_vector(idkey)) %<>%
  left_join(Reduce(rbind, idkey_all), by = "itemid")

```

## Q7. Vitals from chartered events

We are interested in the vitals for ICU patients: heart rate, mean and systolic blood pressure (invasive and noninvasive measurements combined), body temperature, SpO2, and respiratory rate. Find the `itemid`s of these vitals from `d_items.csv.gz` and retrieve a subset of `chartevents.csv.gz` only containing these items.

`chartevents.csv.gz` (<https://mimic-iv.mit.edu/docs/datasets/icu/chartevents/>) contains all the charted data available for a patient. During their ICU stay, the primary repository of a patientâ€™s information is their electronic chart. The `itemid` variable indicates a single measurement type in the database. The `value` variable is the value measured for `itemid`.

`d_items.csv.gz` (<https://mimic-iv.mit.edu/docs/datasets/icu/d_items/>) is the dictionary for the `itemid` in `chartevents.csv.gz`. 

**Quick check the data file**
```{r}
readLines(str_c(mimic_path,"/icu/chartevents.csv.gz"),n = 5L)
```

**begin data processing**
```{r}
item_list2 <- c("heart rate", "blood pressure", 
               "body temperature", "SpO2", "respiratory rate")
char_name <- c("subject_id", "hadm_id", "itemid",
              "charttime", "valuenum")

#read and save
if (!file.exists("chartevents_icu.csv.gz")){
  system.time(chartevents <- fread(str_c(mimic_path,"/icu/chartevents.csv.gz"),
                     select = char_name, nThread = 1))
  chartevents %>%
    semi_join(icustays, by = c("subject_id", "hadm_id")) %>%
    fwrite("chartevents_icu.csv.gz", nThread = 1)
}
system.time(chartevents_icu <- fread("chartevents_icu.csv.gz",
                                     nThread = getDTthreads()))

d_items <- fread(paste0(mimic_path,"/icu/d_items.csv.gz"))

#define lookup function

look_up2 <- function(x){
  d_items %>%
    filter(str_detect(label, regex(x, ignore_case = T))) %>%
    select(itemid,label)
}
find_id2 <- function(x){
  chartevents_icu %>%
    filter(itemid %in% as_vector(x$itemid)) %>%
    count(itemid) %>%
    arrange(desc(n)) -> count
  return(count[1,1])
}

#find item id we need

idkey_all2 <- lapply(item_list2 %>% as.list, look_up2)
idkey2 <- sapply(idkey_all2, find_id2)

chartevents_icu %<>%
  filter(itemid %in% as_vector(idkey2)) %<>%
  left_join(Reduce(rbind, idkey_all2), by = "itemid")

```


## Q8. Putting things together

Let us create a tibble for all ICU stays, where rows are  

- first ICU stay of each unique patient  
- adults (age at admission > 18)  

and columns contain at least following variables  

- all variables in `icustays.csv.gz`  
- all variables in `admission.csv.gz`  
- all variables in `patients.csv.gz`  
- first lab measurements during ICU stay  
- first vitals measurement during ICU stay  
- an indicator variable whether the patient died within 30 days of hospital admission 

```{r, eval=F}
icustays %>%
  semi_join(adm, by = c("subject_id", "hadm_id")) %>%
  semi_join(patients, by = c("subject_id", "hadm_id"))
```


<div class="tocify-extend-page" data-unique="tocify-extend-page" style="height: 0;"></div>