---
title: "Biostat 203B Homework 1"
author: Zian ZHUANG
subtitle: Due Jan 22 @ 11:59PM
output:
  html_document:
    highlight: pygments
    toc: yes
    toc_float: yes
---

<!-- Setup -->
<style type="text/css">
body{ /* Normal  */
      font-size: 17px;
      font-family: "Times New Roman";
  }
h1,h2,h3,h4,h5,h6{
  font-family: "Times New Roman";
}
</style>
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache = TRUE, cache.lazy = FALSE)
library(tidyverse)
library(data.table)
library(lubridate)
library(magrittr)
```
<!-- Begin writing -->

Display machine information for reproducibility:
```{r}
sessionInfo()
```

```{r}
os <- sessionInfo()$running
if (str_detect(os, "Linux")) {
  mimic_path <- "/usr/203b-data/mimic-iv"
} else if (str_detect(os, "macOS")) {
  mimic_path <- "Please double check your path"
}
```
Use tidyverse (ggpot2, dplyr) to explore the [MIMIC-IV](https://mimic-iv.mit.edu) data introduced in [homework 1](https://ucla-biostat203b-2021winter.github.io/hw/hw1/hw1.html).

```{r}
system(str_c("tree -s -L 2 ", shQuote(mimic_path)), intern = TRUE)
```

## Q1. PhysioNet credential

### Q1.1
At this moment, you should already get credentialed on the PhysioNet. Please include a screenshot of your `Data Use Agreement for the MIMIC-IV (v0.4)`.

> **solution**: ![screenshot](/home/zianzhuang/biostat-203b-2021-winter/hw2/agreement.png)
 
## Q2. `read.csv` (base R) vs `read_csv` (tidyverse) vs `fread` (data.table)

There are quite a few utilities in R for reading data files. Let us test the speed of reading a moderate sized compressed csv file, `admissions.csv.gz`, by three programs: `read.csv` in base R, `read_csv` in tidyverse, and `fread` in the popular data.table package. Is there any speed difference?

In this homework, we stick to the tidyverse. 

> **solution**: 
```{r}
timer <- function(fun_input){
  timestart<-Sys.time()
  adm <- fun_input(paste0(mimic_path,"/core/admissions.csv.gz")) 
  timeend<-Sys.time()
  return(timeend-timestart)
}
lapply(list("read_csv" = read_csv,
            "read.csv" = read.csv,
            "fread" = fread),timer)
``` 
`fread` is proved to be the fastest function to read the file. `read.csv` is the slowest function.

## Q3. ICU stays

`icustays.csv.gz` (<https://mimic-iv.mit.edu/docs/datasets/icu/icustays/>) contains data about Intensive Care Units (ICU) stays. Summarize following variables using appropriate numerics or graphs: 

```{r}
icustays <- read_csv(paste0(mimic_path,"/icu/icustays.csv.gz"))
```

### Q3.1
- how many unique `stay_id`? 

> **solution**: 
```{r}
icustays %>% 
  distinct(stay_id) %>% 
  nrow() %>%
  paste0(., " unique stay_id")  
```

### Q3.2
- how many unique `subject_id`?  

> **solution**:
```{r}
icustays %>%  
  distinct(subject_id) %>% 
  nrow() %>%
  paste0(., " unique subject_id")
```

### Q3.3
- length of ICU stay

> **solution**:
```{r}
icustays$los %>% summary
ggplot(data = icustays) +
  geom_density(mapping = aes(x = los)) +
  scale_x_log10() +
  xlab("length of ICU stay")+
  theme_classic() 
```

### Q3.4
- first ICU unit 

> **solution**:
```{r}
icustays %>% 
  group_by(first_careunit) %>% 
  summarise(n = n()) %>%
  arrange(desc(n))
ggplot(data = icustays, 
       mapping = aes(x = factor(1), fill = first_careunit)) +
  scale_fill_discrete(name = "ICUs") +
  xlab(NULL) +
  ylab(NULL) +
  geom_bar() + 
  coord_polar("y") +
  theme(axis.ticks = element_blank(), 
        axis.text.y = element_blank())
```

### Q3.5
- last ICU unit

> **solution**:
```{r}
icustays %>% 
  group_by(last_careunit) %>% 
  summarise(n = n()) %>%
  arrange(desc(n))
ggplot(data = icustays, 
       mapping = aes(x = factor(1), fill = last_careunit)) +
  scale_fill_discrete(name = "ICUs") +
  xlab(NULL) +
  ylab(NULL) +
  geom_bar() + 
  coord_polar("y") +
  theme(axis.ticks = element_blank(), 
        axis.text.y = element_blank())
```

## Q4. `admission` data

Information of the patients admitted into hospital is available in `admissions.csv.gz`. See <https://mimic-iv.mit.edu/docs/datasets/core/admissions/> for details of each field in this file. Summarize following variables using appropriate graphs. Explain any patterns you observe.   

```{r}
adm <- read_csv(paste0(mimic_path,"/core/admissions.csv.gz"))
```

### Q4.1
- admission year

> **solution**:
```{r}
adm %<>% mutate(admission_year=year(adm$admittime))
adm$admission_year %>% summary
ggplot(adm, aes(x=admission_year)) + 
 geom_histogram(aes(y=..density..), colour="black", fill="white")+
 geom_density(alpha=.2, fill="#FF6666") +
 theme_classic()
```

- admission month 

> **solution**:
```{r}
adm %<>% mutate(admission_month=month(adm$admittime))
adm %>% 
  group_by(admission_month) %>% 
  summarise(n = n()) %>%
  arrange(desc(n))
ggplot(data = adm, 
       mapping = aes(x = factor(1), fill = admission_month %>% as.factor())) +
  scale_fill_discrete(name = "Month") +
  xlab(NULL) +
  ylab(NULL) +
  geom_bar() + 
  coord_polar("y") +
  theme(axis.ticks = element_blank(), 
        axis.text.y = element_blank())
```

- admission month day  
- admission week day  
- admission hour (anything unusual?)  
- number of deaths in each year  
- admission type  
- number of admissions per patient  
- admission location  
- discharge location  
- insurance  
- language  
- martial status  
- ethnicity  
- death


<div class="tocify-extend-page" data-unique="tocify-extend-page" style="height: 0;"></div>